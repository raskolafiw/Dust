# DartScript Active Context

## Current Focus

- **Implementing `<dart-script src="...">` functionality:** Focusing on loading
  and running pre-compiled Dart WASM modules specified via the `src` attribute.
- **Defining Core Framework Value:** Establishing the simplified loading
  mechanism and planning the standardized DOM API provided by the DartScript
  framework.

## Recent Changes

- Created initial project structure (HTML, JS loader, Dart source).
- Iteratively debugged Dart-JS interop issues for WASM compilation.
- Successfully compiled Dart to WASM (`dart compile wasm`).
- Successfully loaded the WASM module using the generated JS helper
  (`main.mjs`).
- Achieved DOM manipulation from Dart by scheduling the interop call
  asynchronously (`Timer.run`) during PoC.
- **(Previous) Implemented code retrieval from `<dart-script>` tag:** (This
  mechanism will be removed/adapted as inline execution is no longer the goal).
  - Added `<dart-script>` tag to `index.html` (will be changed to use `src`).
  - Modified `js/loader.js` to define `window.dartScriptGetCode` (will be
    removed).
  - Modified `dart/main.dart` to call `window.dartScriptGetCode` (will be
    removed).
  - Successfully passed the tag's `textContent` from JS to Dart/WASM.
  - Confirmed Dart receives the code string correctly.
  - Resolved issues with JS interop type checking (`instanceOfString`).

## Next Steps

- **Implement `<dart-script src="...">` loading:**
  - Modify `js/loader.js` to find all `<dart-script>` tags with a `src`
    attribute.
  - For each tag, fetch the corresponding WASM module (likely using the standard
    JS loader generated by `dart compile wasm`, e.g., `[src_name].mjs`).
  - Instantiate the WASM module.
  - Potentially pass configuration from tag attributes to the WASM module.
- **Define initial DartScript DOM API:** Plan the basic Dart functions/classes
  that loaded WASM modules can use for DOM interaction (e.g., getting elements,
  setting text, adding listeners). This will likely involve JS interop within
  the DartScript framework's WASM core (or the JS loader).
- **Handle multiple `<dart-script src="...">` tags:** Ensure the loader
  correctly manages multiple instances.
- **Refine error handling:** Implement error reporting for issues during WASM
  loading and instantiation.
- **Cleanup:** Remove the now-unused `window.dartScriptGetCode` function from
  `js/loader.js` and the corresponding call from `dart/main.dart`.
- Update `progress.md` to reflect the scope change and new focus.

## Active Decisions & Considerations

- **JS Interop Pattern:** Confirmed that Dart initiating calls to predefined JS
  functions (like `window.dartScriptGetCode`) is the reliable pattern for this
  WASM interop scenario. Exporting Dart functions/classes/statics via
  `@JSExport` proved unreliable/unsupported by the `dart compile wasm` toolchain
  for direct JS calls _into_ Dart.
- **Code Execution Strategy Decision:** Decided to abandon inline code execution
  due to technical challenges with AOT WASM. The project will focus exclusively
  on loading pre-compiled WASM modules via `<dart-script src="...">`.
- **Interpreter Search:** Confirmed via web search that finding pre-built,
  WASM-compilable Dart interpreters is difficult.
- Using `dhttpd` as the local development server.
- **Client-Side Compilation:** Confirmed via web search that client-side
  Dart-to-JavaScript compilers are not readily available.
