# Dust System Patterns

## Core Framework Architecture

- **WASM Runtime:** Dart runtime compiled to WebAssembly (WASM) via
  `dart compile wasm`.
- **Component Model:**
  - UI built by composing `Component` instances (`StatelessWidget`,
    `StatefulWidget`).
  - `StatefulWidget` uses a `State` object for mutable state and UI building.
  - `State` has lifecycle methods (`initState`, `build`, `dispose`, etc.) and
    `setState` for triggering updates.
  - `State.build()` returns a `VNode` tree (with keys, attributes, children, and
    listeners using `DomEvent`) representing the desired UI structure.
- **Declarative Rendering Engine (Keyed Diffing):**
  - Developers declare UI in `build()` methods, ideally using HTML helper
    functions (e.g., `div()`, `h1()`) which return a `VNode` tree.
  - **Initial Render:** Handles `StatefulWidget` creation and initial `build`
    via `_patch` (with `oldVNode` as null).
  - **Update Mechanism (Keyed Diffing):** `setState` calls a callback provided
    by the renderer (`_performRender`). `_performRender` re-runs `build` to get
    the new `VNode` tree and calls `_patch`.
  - **Patching (`_patch`):** Compares the new and old `VNode` trees at the root
    level. Handles node addition/removal/replacement, text updates, attribute
    updates, and **event listener updates** (now wrapping callbacks to pass
    `DomEvent`). Delegates child patching to `_patchChildren`. `VNode.domNode`
    links VNodes to their corresponding DOM nodes. `VNode.jsFunctionRefs` stores
    JS references for listeners.
  - **Child Patching (`_patchChildren`):** Implements a keyed reconciliation
    algorithm to efficiently update child lists (handling additions, removals,
    reordering, and updates based on `VNode.key`).
- **State Management:**
  - Basic component state managed via `State` and `setState`.
  - External libraries like Riverpod can be used (demonstrated in clock example,
    though integration needs refinement).
  - Framework-level context/DI patterns are future goals.
- **Routing:** (Not yet implemented) Goal is a client-side SPA router.
- **JavaScript Bridge:**
  - **WASM Loading:** Handled by the JS loader generated by `build_runner`
    (`web/main.dart.js`), which imports functions from the compiled WASM module
    (`web/main.wasm`) and its JS bridge (`web/main.mjs`).
  - **Dart <-> JS Communication:** Uses `dart:js_interop`. Dart calls JS
    functions (defined via `@JS`) for DOM manipulation and browser APIs (like
    `addEventListener`). JS calls exported Dart functions (e.g., `$invokeMain`).
  - **DOM Access & Event Handling:** Currently direct JS interop calls within
    the renderer (`_createDomElement`, `_patch`). Dart event callbacks are
    wrapped in a JS function that passes a `DomEvent` object, then converted to
    `JSFunction` using `.toJS`. A Dart DOM abstraction layer is planned.
- **Application Entry Point:**
  - `web/index.html` loads the `build_runner` generated `web/main.dart.js` as a
    module.
  - `web/main.dart.js` handles WASM loading and calls the exported `$invokeMain`
    function.
  - `$invokeMain` executes the Dart `main()` function in `web/main.dart`.
  - User's Dart `main()` calls the framework's `runApp` function (defined in
    `dust_renderer`) to mount the root component.
- **Sandboxing:** Execution remains within the browser's WASM sandbox.

## Key Technical Decisions (Framework Context)

- **Rendering Strategy:** Implemented a keyed Virtual DOM diffing/patching
  strategy (`_patch` delegating to `_patchChildren`). Further optimization is
  possible.
- **Component API Design:** Current class-based approach is similar to Flutter.
  `build()` return type is `VNode`. Developers are encouraged to use HTML helper
  functions (`package:dust_component/html.dart`) for better readability. `VNode`
  includes `key`, `listeners` (using `DomEvent`), and `jsFunctionRefs`. Further
  refinement needed for props and context.
- **State Management Approach:** Provide built-in context or focus on
  integrating external libraries like Riverpod?
- **JS/WASM Bridge Implementation:** Using `dart:js_interop`. Confirmed `.toJS`
  extension method on a wrapper function
  `(JSAny jsEvent) { dartCallback(DomEvent(jsEvent)); }` for passing Dart
  callbacks to JS for event listeners. Introduced `DomEvent` wrapper. How to
  create an efficient Dart DOM abstraction layer?
- **Build Tooling Integration:** How to integrate for hot reload and production
  builds?

## Core Patterns

- **Declarative UI Helpers Pattern:** Providing functions (`div`, `h1`, etc.)
  that mirror HTML tags to simplify `VNode` creation in `build` methods.

- **Component Pattern:** Core UI building block.
- **State Management Pattern:** Using `State` for local state; external
  libraries (Riverpod) for app state.
- **Observer Pattern:** Implicitly used via `StreamProvider` and `setState`
  triggering updates.
- **Callback Pattern:** Used for `State` to request updates from the renderer.
- **Facade Pattern:** (Goal) For the Dart DOM abstraction layer.
- **Bootstrap Pattern:** `build_runner` generates the necessary JS bootstrap
  code (`web/main.dart.js`) to load and initialize the WASM application.
- **Application Runner Pattern:** Framework provides a simple `runApp` function
  as the public entry point for users.
- **Virtual DOM Node Pattern:** Using `VNode` objects to represent the desired
  DOM structure in memory, linked to actual DOM nodes via `domNode` property,
  using `DomEvent` for listeners, and storing JS listener references in
  `jsFunctionRefs`.
- **Diffing/Patching Pattern:** Comparing VNode trees (`_patch`) and applying
  targeted updates to the DOM (including attributes and listeners). Uses keyed
  reconciliation (`_patchChildren`) for efficient list updates.
- **Event Listener Management Pattern:** Wrapping Dart callbacks
  `(DomEvent event) => ...` in a JS function
  `(JSAny jsEvent) { dartCallback(DomEvent(jsEvent)); }`, converting the wrapper
  using `.toJS`, storing the `JSFunction` reference on the `VNode`, and using
  these references in `_patch` to add/remove listeners. Listener update logic in
  `_patch` simplified.
